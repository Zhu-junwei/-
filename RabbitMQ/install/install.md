[toc]# 通过软件包安装## 下载rabbitmq安装包[Releases · rabbitmq/rabbitmq-server · GitHub](https://github.com/rabbitmq/rabbitmq-server/releases)## 下载Erlang安装包[Releases · rabbitmq/erlang-rpm · GitHub](https://github.com/rabbitmq/erlang-rpm/releases)[rabbitmq和erlang对应关系](https://www.rabbitmq.com/which-erlang.html#compatibility-matrix)## 上传至服务器![20220312_062340](img/20220312_062340.png)## 安装命令```shellrpm -ivh erlang-23.3.4.11-1.el7.x86_64.rpmyum install socat logrotate -yrpm -ivh rabbitmq-server-3.9.13-1.el7.noarch.rpm```## 安装web管理界面```shellrabbitmq-plugins enable rabbitmq_management```启动、停止MQ```shellservice status rabbit-serverservice start rabbit-serverservice stop rabbit-server```# 通过Docker安装**确保系统已经docker**## 目录及配置文件准备准备目录```bash# rabbitmq文件配置目录mkdir -p /data/rabbitmq/conf# 持久化文件存放目录mkdir -p /data/rabbitmq/data```准备enabled_plugins配置文件> 新建enabled_plugins文件，配置需要启动的插件，放在/data/rabbitmq/conf目录下```bash# 进入目录下cd /data/rabbitmq/conf# 创建enabled_plugins文件touch enabled_plugins```enabled_plugins文件内容> rabbitmq_prometheus，原始镜像里默认开启了,我修改为了如下内容，添加了开启管理界面插件```bash[rabbitmq_management,rabbitmq_prometheus].```## 拉取镜像```bashdocker pull rabbitmq```## 开通防火墙```bash# 开通5672端口（AMQP）sudo firewall-cmd --add-port=5672/tcp --permanentsudo firewall-cmd --add-port=15672/tcp --permanentsudo firewall-cmd --reload```## 编写run脚本> 通过脚本创建并启动docker容器```bashdocker run -d \--name=rabbitmq \--hostname=Rabbit \--restart=always \-e RABBITMQ_DEFAULT_USER=admin \-e RABBITMQ_DEFAULT_PASS=123456 \-p 5672:5672 \-p 15672:15672 \-v /data/rabbitmq/conf/enabled_plugins:/etc/rabbitmq/enabled_plugins \rabbitmq:latest````-d `：后台方式启动`--name`: 指定容器名称`--hostname`: 指定容器主机名称`--restart`: 设置开机自启`-i`：以交互模式运行容器，通常与 -t 同时使用；`-t`：为容器重新分配一个伪输入终端，通常与 -i 同时使用；`-p`: 指定端口映射`RABBITMQ_DEFAULT_USER`、`RABBITMQ_DEFAULT_PASS`登录rabbitmq管理界面的用户名和密码`5672`: RabbitMQ 默认端口`15672`: RabbitMQ 管理插件的 Web 界面端口## 常用命令```bash# 查看容器状态docker ps -a# 停止容器docker stop rabbitmq# 启动容器docker start rabbitmq# 重启容器，相当于停止后再启动docker restart rabbitmq# 删除容器，请先停止后再删除。删除后需要再次通过run脚本进行创建启动。docker rm rabbitmq```## 安装额外的插件### 安装rabbitmq_delayed_message_exchange插件> 该插件可以创建延迟交换机，消息在达到指定延迟时间后才会发送到指定的队列中。[Rabbit plugins](https://www.rabbitmq.com/community-plugins.html)[插件GitHub](https://github.com/rabbitmq/rabbitmq-delayed-message-exchange)下载```bashwget https://github.com/rabbitmq/rabbitmq-delayed-message-exchange/releases/download/v3.12.0/rabbitmq_delayed_message_exchange-3.12.0.ez```上传到docker的插件目录下```bash# docker cp 目的主机路径 容器ID:容器内路径docker cp rabbitmq_delayed_message_exchange-3.12.0.ez rabbitmq:/plugins# 修改一下文件的所属用户及分组，我这里复制过去后是root了。# 在容器内执行 chown 命令修改文件的属主docker exec rabbitmq chown rabbitmq:rabbitmq /plugins/rabbitmq_delayed_message_exchange-3.12.0.ez```设置需要开启的插件> 我这里把需要开启的插件放在了容器外部，方便重新重建容器的时候可以生效。```bashcd /data/rabbitmq/confvim enabled_plugins```enabled_plugins文件内容```bash[rabbitmq_delayed_message_exchange,rabbitmq_management,rabbitmq_prometheus].```也可以进入容器内部执行`rabbitmq-plugins enable rabbitmq_delayed_message_exchange`开启插件，不过这样重启会失效。重启docker容器```bashdocker restart rabbitmq```### 验证是否安装成功重启后查看运行的插件```bashdocker exec -it rabbitmq rabbitmq-plugins list```登录[http://192.168.234.121:15672/](http://192.168.234.121:15672/)查看新建exchange时有没有type为`x-delayed-message`![](./img/install-plugin.png)> 如果存在代表安装成功。## 验证RabbitMQ是否正常访问RabbitMQ管理页面：http://192.168.234.121:15672/ ，用户名是run脚本设置的`admin`，密码是`123456`。如果脚本没有设置用户名和密码，默认用户名和密码都是`guest`如果有问题，可以通过`docker logs rabbitmq`命令查看是否有日志报错。## 容器内部操作### RabbitMQ默认的配置```shell# 容器内部cat /etc/rabbitmq/enabled_plugins``````bash[rabbitmq_prometheus].```### 查看已经启动的插件```bashrabbitmq-plugins list``````bashroot@Rabbit:/etc/rabbitmq# rabbitmq-plugins listListing plugins with pattern ".*" ... Configured: E = explicitly enabled; e = implicitly enabled | Status: * = running on rabbit@Rabbit |/[  ] rabbitmq_amqp1_0                  3.12.12[  ] rabbitmq_auth_backend_cache       3.12.12[  ] rabbitmq_auth_backend_http        3.12.12[  ] rabbitmq_auth_backend_ldap        3.12.12[  ] rabbitmq_auth_backend_oauth2      3.12.12[  ] rabbitmq_auth_mechanism_ssl       3.12.12[  ] rabbitmq_consistent_hash_exchange 3.12.12[  ] rabbitmq_event_exchange           3.12.12[  ] rabbitmq_federation               3.12.12[  ] rabbitmq_federation_management    3.12.12[  ] rabbitmq_jms_topic_exchange       3.12.12[  ] rabbitmq_management               3.12.12[e*] rabbitmq_management_agent         3.12.12[  ] rabbitmq_mqtt                     3.12.12[  ] rabbitmq_peer_discovery_aws       3.12.12[  ] rabbitmq_peer_discovery_common    3.12.12[  ] rabbitmq_peer_discovery_consul    3.12.12[  ] rabbitmq_peer_discovery_etcd      3.12.12[  ] rabbitmq_peer_discovery_k8s       3.12.12[E*] rabbitmq_prometheus               3.12.12[  ] rabbitmq_random_exchange          3.12.12[  ] rabbitmq_recent_history_exchange  3.12.12[  ] rabbitmq_sharding                 3.12.12[  ] rabbitmq_shovel                   3.12.12[  ] rabbitmq_shovel_management        3.12.12[  ] rabbitmq_stomp                    3.12.12[  ] rabbitmq_stream                   3.12.12[  ] rabbitmq_stream_management        3.12.12[  ] rabbitmq_top                      3.12.12[  ] rabbitmq_tracing                  3.12.12[  ] rabbitmq_trust_store              3.12.12[e*] rabbitmq_web_dispatch             3.12.12[  ] rabbitmq_web_mqtt                 3.12.12[  ] rabbitmq_web_mqtt_examples        3.12.12[  ] rabbitmq_web_stomp                3.12.12[  ] rabbitmq_web_stomp_examples       3.12.12```### 管理界面Connections点击报错如果在RabbitMQ的管理页面点击Connections页面出现了`Stats in management UI are disabled on this node`提示。需要做如下配置> 修改management_agent.disable_metrics_collector = false```bash# 进入容器内部docker exec -it rabbitmq /bin/bash# 进入配置文件所在目录cd /etc/rabbitmq/conf.d/# 修改配置文件echo management_agent.disable_metrics_collector = false > 20-management_agent.disable_metrics_collector.conf# 退出后重启容器exitdocker restart rabbitmq```> 我现在测试的时候使用的是3.12.12版本，后面官网不知道会不会修复这个问题。